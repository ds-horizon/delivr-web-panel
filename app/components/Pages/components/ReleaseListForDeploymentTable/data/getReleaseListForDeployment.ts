import { installGlobals } from "@remix-run/node";
import axios, { AxiosResponse } from "axios";
import { route } from "routes-gen";
import { N } from "vitest/dist/chunks/environment.LoooBwUu.js";
import {
  DeploymentsReleaseRequest,
  DeploymentsReleaseResponse,
} from "~/.server/services/Codepush/types";

export type ReleaseListResponse = {
  id: string;
  label: string;
  targetVersions: string;
  status: boolean;
  mandatory: boolean;
  rollbacks: number;
  activeDevices: number;
  downloaded: number;
  installed: number;
  totalActive: number;
  rollout: number;
  releasedAt: number;
  description: string;
  releasedBy: string;
};

// const data: ReleaseListResponse[] = [
//   {
//     id: "1",
//     label: "v9.6.3",
//     targetVersions: "10.6.4",
//     status: true,
//     mandatory: true,
//     rollbacks: 1,
//     activeDevices: 1211,
//     rollout: 16,
//     releasedAt: "2024-10-18T05:53:57",
//     description: "Bit center community real.",
//     releasedBy: "Tracy Stokes",
//   },
//   {
//     id: "2",
//     label: "v1.0.8",
//     targetVersions: "1.0.9",
//     status: true,
//     mandatory: false,
//     rollbacks: 2,
//     activeDevices: 4041,
//     rollout: 93,
//     releasedAt: "2024-03-19T04:09:39",
//     description: "Be one imagine down home forward.",
//     releasedBy: "Bobby Gray",
//   },
//   {
//     id: "3",
//     label: "v4.1.9",
//     targetVersions: "9.8.6",
//     status: false,
//     mandatory: true,
//     rollbacks: 7,
//     activeDevices: 5438,
//     rollout: 54,
//     releasedAt: "2024-09-05T00:58:09",
//     description: "Student shoulder share model range.",
//     releasedBy: "Lisa Sharp",
//   },
//   {
//     id: "4",
//     label: "v5.7.4",
//     targetVersions: "7.1.2",
//     status: false,
//     mandatory: false,
//     rollbacks: 7,
//     activeDevices: 171,
//     rollout: 51,
//     releasedAt: "2024-04-11T05:56:06",
//     description: "Three second man beyond across need question.",
//     releasedBy: "Donna Campbell",
//   },
//   {
//     id: "5",
//     label: "v4.4.0",
//     targetVersions: "1.7.9",
//     status: false,
//     mandatory: true,
//     rollbacks: 2,
//     activeDevices: 1869,
//     rollout: 97,
//     releasedAt: "2024-02-04T01:17:43",
//     description: "Mean real economy tree poor tough contain.",
//     releasedBy: "Colleen Banks",
//   },
//   {
//     id: "6",
//     label: "v9.3.6",
//     targetVersions: "3.6.5",
//     status: true,
//     mandatory: true,
//     rollbacks: 4,
//     activeDevices: 1742,
//     rollout: 58,
//     releasedAt: "2024-03-06T18:42:52",
//     description: "Particular throw painting easy site environment.",
//     releasedBy: "Michael Lewis",
//   },
//   {
//     id: "7",
//     label: "v7.4.5",
//     targetVersions: "8.7.4",
//     status: true,
//     mandatory: false,
//     rollbacks: 8,
//     activeDevices: 1227,
//     rollout: 35,
//     releasedAt: "2024-02-09T09:52:23",
//     description: "Common lot eye home week.",
//     releasedBy: "Joan Harvey",
//   },
//   {
//     id: "8",
//     label: "v3.8.2",
//     targetVersions: "7.5.6",
//     status: false,
//     mandatory: false,
//     rollbacks: 9,
//     activeDevices: 5063,
//     rollout: 66,
//     releasedAt: "2024-09-15T22:47:06",
//     description: "Alone read top almost specific building new.",
//     releasedBy: "Victoria Warren",
//   },
//   {
//     id: "9",
//     label: "v2.3.5",
//     targetVersions: "2.1.4",
//     status: true,
//     mandatory: true,
//     rollbacks: 7,
//     activeDevices: 2695,
//     rollout: 77,
//     releasedAt: "2024-07-08T23:35:57",
//     description: "See include no produce ball.",
//     releasedBy: "Lori Snyder",
//   },
//   {
//     id: "10",
//     label: "v1.2.3",
//     targetVersions: "9.1.7",
//     status: false,
//     mandatory: false,
//     rollbacks: 6,
//     activeDevices: 1586,
//     rollout: 88,
//     releasedAt: "2024-08-09T12:15:34",
//     description: "Course very class last point friend seem.",
//     releasedBy: "Matthew George",
//   },
//   {
//     id: "11",
//     label: "v7.0.1",
//     targetVersions: "6.5.2",
//     status: false,
//     mandatory: true,
//     rollbacks: 1,
//     activeDevices: 2176,
//     rollout: 83,
//     releasedAt: "2024-02-23T20:22:49",
//     description: "Research property development total majority fine lead.",
//     releasedBy: "Diane Mendoza",
//   },
//   {
//     id: "12",
//     label: "v2.5.9",
//     targetVersions: "5.4.9",
//     status: true,
//     mandatory: true,
//     rollbacks: 9,
//     activeDevices: 3314,
//     rollout: 91,
//     releasedAt: "2024-05-16T13:31:21",
//     description: "Mission relate fact room bring attention.",
//     releasedBy: "Aaron Robertson",
//   },
//   {
//     id: "13",
//     label: "v5.7.8",
//     targetVersions: "10.4.7",
//     status: true,
//     mandatory: true,
//     rollbacks: 1,
//     activeDevices: 1748,
//     rollout: 41,
//     releasedAt: "2024-03-27T16:33:44",
//     description: "Success city expert stop lot attack.",
//     releasedBy: "Brian Hill",
//   },
//   {
//     id: "14",
//     label: "v4.2.4",
//     targetVersions: "6.8.1",
//     status: true,
//     mandatory: false,
//     rollbacks: 10,
//     activeDevices: 4075,
//     rollout: 62,
//     releasedAt: "2024-07-23T13:57:06",
//     description: "Growth however material everyone activity respond.",
//     releasedBy: "Amy Simpson",
//   },
//   {
//     id: "15",
//     label: "v7.6.0",
//     targetVersions: "9.0.0",
//     status: false,
//     mandatory: true,
//     rollbacks: 7,
//     activeDevices: 4004,
//     rollout: 80,
//     releasedAt: "2024-04-03T01:30:16",
//     description: "Authority blue rule short everything animal.",
//     releasedBy: "Anthony Griffin",
//   },
//   {
//     id: "16",
//     label: "v3.4.7",
//     targetVersions: "3.0.5",
//     status: true,
//     mandatory: true,
//     rollbacks: 6,
//     activeDevices: 4397,
//     rollout: 11,
//     releasedAt: "2024-02-21T07:33:53",
//     description: "Toward reality safe voice strong realize.",
//     releasedBy: "Melissa Jackson",
//   },
//   {
//     id: "17",
//     label: "v9.4.5",
//     targetVersions: "6.1.4",
//     status: false,
//     mandatory: true,
//     rollbacks: 3,
//     activeDevices: 3235,
//     rollout: 14,
//     releasedAt: "2024-09-11T18:42:11",
//     description: "Where already accept meet tough truth eye.",
//     releasedBy: "Janet Brown",
//   },
//   {
//     id: "18",
//     label: "v5.2.1",
//     targetVersions: "8.9.4",
//     status: true,
//     mandatory: false,
//     rollbacks: 4,
//     activeDevices: 1483,
//     rollout: 34,
//     releasedAt: "2024-08-17T22:29:59",
//     description: "Product only everyone professional approach.",
//     releasedBy: "Larry Morris",
//   },
//   {
//     id: "19",
//     label: "v6.0.8",
//     targetVersions: "4.1.5",
//     status: false,
//     mandatory: true,
//     rollbacks: 10,
//     activeDevices: 4631,
//     rollout: 12,
//     releasedAt: "2024-09-12T15:11:36",
//     description: "Take program call ahead.",
//     releasedBy: "Jessica Kelley",
//   },
//   {
//     id: "20",
//     label: "v2.6.4",
//     targetVersions: "7.7.8",
//     status: true,
//     mandatory: false,
//     rollbacks: 8,
//     activeDevices: 1499,
//     rollout: 68,
//     releasedAt: "2024-01-24T23:58:48",
//     description: "Difficult plan party position wide teacher size.",
//     releasedBy: "Phillip Reed",
//   },
//   {
//     id: "21",
//     label: "v3.0.9",
//     targetVersions: "3.4.0",
//     status: false,
//     mandatory: true,
//     rollbacks: 9,
//     activeDevices: 1373,
//     rollout: 24,
//     releasedAt: "2024-05-07T20:44:16",
//     description: "Notice music born interview perform simply heart.",
//     releasedBy: "Dylan Schmidt",
//   },
//   {
//     id: "22",
//     label: "v8.4.6",
//     targetVersions: "4.2.1",
//     status: false,
//     mandatory: false,
//     rollbacks: 3,
//     activeDevices: 2104,
//     rollout: 43,
//     releasedAt: "2024-10-01T08:13:51",
//     description: "Method thousand day eight without body check.",
//     releasedBy: "Brenda Gonzales",
//   },
//   {
//     id: "23",
//     label: "v9.7.2",
//     targetVersions: "10.2.5",
//     status: false,
//     mandatory: true,
//     rollbacks: 4,
//     activeDevices: 1439,
//     rollout: 19,
//     releasedAt: "2024-08-22T12:50:42",
//     description: "Interesting focus receive event ever citizen.",
//     releasedBy: "Christopher Torres",
//   },
//   {
//     id: "24",
//     label: "v1.9.9",
//     targetVersions: "4.0.6",
//     status: false,
//     mandatory: false,
//     rollbacks: 5,
//     activeDevices: 3367,
//     rollout: 51,
//     releasedAt: "2024-10-05T12:01:37",
//     description: "Point support kind million close pull yourself.",
//     releasedBy: "Nancy Clark",
//   },
//   {
//     id: "25",
//     label: "v8.2.6",
//     targetVersions: "5.5.3",
//     status: true,
//     mandatory: true,
//     rollbacks: 4,
//     activeDevices: 2066,
//     rollout: 73,
//     releasedAt: "2024-05-13T18:20:05",
//     description: "Modern economy high either current.",
//     releasedBy: "Dennis Powell",
//   },
//   {
//     id: "26",
//     label: "v7.7.1",
//     targetVersions: "3.2.9",
//     status: true,
//     mandatory: false,
//     rollbacks: 1,
//     activeDevices: 2531,
//     rollout: 59,
//     releasedAt: "2024-01-29T06:40:51",
//     description: "Community nature protect establish either idea pick.",
//     releasedBy: "Kelly Nelson",
//   },
//   {
//     id: "27",
//     label: "v9.4.8",
//     targetVersions: "6.0.1",
//     status: true,
//     mandatory: true,
//     rollbacks: 2,
//     activeDevices: 2756,
//     rollout: 86,
//     releasedAt: "2024-04-25T04:10:24",
//     description: "Natural wonder institution area shoulder like.",
//     releasedBy: "Mark Mitchell",
//   },
//   {
//     id: "28",
//     label: "v7.0.4",
//     targetVersions: "8.5.6",
//     status: false,
//     mandatory: true,
//     rollbacks: 5,
//     activeDevices: 4998,
//     rollout: 45,
//     releasedAt: "2024-03-11T00:12:13",
//     description: "Moment personal increase cost allow.",
//     releasedBy: "Katherine Adams",
//   },
//   {
//     id: "29",
//     label: "v8.8.3",
//     targetVersions: "2.6.3",
//     status: false,
//     mandatory: true,
//     rollbacks: 4,
//     activeDevices: 4685,
//     rollout: 67,
//     releasedAt: "2024-06-21T19:03:27",
//     description: "Assume find project power tell opportunity.",
//     releasedBy: "Kevin Fisher",
//   },
//   {
//     id: "30",
//     label: "v1.8.0",
//     targetVersions: "10.8.7",
//     status: true,
//     mandatory: false,
//     rollbacks: 9,
//     activeDevices: 2174,
//     rollout: 83,
//     releasedAt: "2024-04-09T15:26:18",
//     description: "Course space experience mind front instead represent.",
//     releasedBy: "Tina Perry",
//   },
// ];

export type GetReleaseParamArgs = Omit<DeploymentsReleaseRequest, "userId">;

export const getReleaseListForDeployment = async (
  params: GetReleaseParamArgs
): Promise<ReleaseListResponse[]> => {
  const { data } = await axios.get<
    null,
    AxiosResponse<DeploymentsReleaseResponse>
  >(
    route("/api/v1/:app/deployments/:deploymentName", {
      app: params.appId,
      deploymentName: params.deploymentName,
    })
  );

  return data.deployment.packageHistory.map((item) => {
    return {
      id: item.label,
      label: item.label,
      targetVersions: item.appVersion,
      status: !item.isDisabled,
      mandatory: item.isMandatory,
      rollbacks: item?.failed || 0,
      activeDevices: item?.active || 0,
      downloaded: item?.downloaded || 0,
      installed: item?.installed || 0,
      totalActive: item?.totalActive || 0,
      rollout: item.rollout,
      releasedAt: item.uploadTime,
      description: item.description,
      releasedBy: item.releasedBy,
    };
  });
};
